
name: e2e test with kind

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  pull_request:
    branches: [ master ]

env:
  # TODO: Change variable to your image's name.
  OSD_IMAGE: quay.io/openstorage/osd

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:    
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it 
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: make docker-build-osd
    
    - name: Log into registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

    - name: Push image
      run: |
        IMAGE_ID=docker.pkg.github.com/${{ github.repository }}/demo
        VERSION=$(date +%s)

        echo IMAGE_ID=$IMAGE_ID
        echo VERSION=$VERSION

        docker tag $OSD_IMAGE $IMAGE_ID:$VERSION
        docker push $IMAGE_ID:$VERSION
    
  
  # KinD Cluster Creation
  test:
    # this job is dependent of the previous one completing
    needs: build
    
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    
    # Defines the matrix build for K8s versions
    strategy:
      matrix:
        k8s-version: ['v1.18.6']
        #k8s-version: ['v1.16.9', 'v1.17.5', 'v1.18.6']
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
      
    # Creates KinD with using k8s versions from the matrix above
    - name: Set up KinD with K8s version ${{ matrix.k8s-version }}
      uses: engineerd/setup-kind@v0.4.0
      with:
          name: openstorage-test-cluster
          config: hack/kind.yaml
          image: kindest/node:${{ matrix.k8s-version }}
          
    - name: Start openstorage
      run: |
        kubectl apply -f demo/setup

    - name: Environment setup check
      run: |
        kubectl cluster-info
        kubectl get pods -n kube-system

    - name: Run tests
      run: |
        echo "Running tests:"
        ./demo/test.sh
